Backport of:

From 3849992b16011e36a5cb5be4b127f843389b96fd Mon Sep 17 00:00:00 2001
From: Bram Moolenaar <Bram@vim.org>
Date: Fri, 22 Apr 2016 20:46:52 +0200
Subject: [PATCH] patch 7.4.1777 Problem:    Newly added features can escape
 the sandbox. Solution:   Add checks for restricted and secure. (Yasuhiro
 Matsumoto)

---
 src/eval.c    | 8 ++++++--
 src/version.c | 2 ++
 2 files changed, 8 insertions(+), 2 deletions(-)

--- a/src/eval.c
+++ b/src/eval.c
@@ -10182,6 +10182,8 @@ f_ch_logfile(typval_T *argvars, typval_T
 f_ch_open(typval_T *argvars, typval_T *rettv)
 {
     rettv->v_type = VAR_CHANNEL;
+    if (check_restricted() || check_secure())
+	return;
     rettv->vval.v_channel = channel_open_func(argvars);
 }
 
@@ -14830,6 +14832,8 @@ f_job_setoptions(typval_T *argvars, typv
 f_job_start(typval_T *argvars, typval_T *rettv)
 {
     rettv->v_type = VAR_JOB;
+    if (check_restricted() || check_secure())
+	return;
     rettv->vval.v_job = job_start(argvars);
 }
 
@@ -16573,8 +16577,6 @@ check_connection(void)
 #endif
 
 #ifdef FEAT_CLIENTSERVER
-static void remote_common(typval_T *argvars, typval_T *rettv, int expr);
-
     static void
 remote_common(typval_T *argvars, typval_T *rettv, int expr)
 {
@@ -20323,6 +20325,8 @@ f_timer_start(typval_T *argvars, typval_
     char_u  *callback;
     dict_T  *dict;
 
+    if (check_secure())
+	return;
     if (argvars[2].v_type != VAR_UNKNOWN)
     {
 	if (argvars[2].v_type != VAR_DICT
